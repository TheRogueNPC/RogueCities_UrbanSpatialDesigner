# Audit Report – 2026-02-26

## Recent Changelog Summary

- **Unreleased (2026‑02‑25)** – UI regression fix, architectural refactor moving `GeometryPolicy` to the app layer, core generator logic additions (`FrontageProfiler.cpp`, `Policies.cpp`), polygon clipping with Clipper2, UI framework & panels updates, viewport spatial indexing, and numerous performance improvements.
- **0.11.0 (2026‑02‑24)** – Introduced GEMINI mandates, grid quality analytics, spline tool architecture, telemetry UI integration, event system (`Infomatrix`), UI layout refactor, build system hardening, and core utility consolidation.
- **0.10.0 (2026‑02‑19)** – Added determinism hashing, fixed‑step simulation pipeline, stable viewport ID registry, incremental generation APIs, AESP scoring profile, and CMake package export.

## TODO / FIXME / STUB / AUDIT Comments (Visualizer Layer)

... (existing content omitted for brevity) ...

## Additional TODO / FIXME / STUB / AUDIT Comments (Core Layer)

### core/include/RogueCity/Core/Editor/GlobalState.hpp
- **Line 296**: `Stub,` (enum placeholder for future stub handling).

## Additional TODO / FIXME / STUB / AUDIT Comments (Docs Layer)

### docs/TODO_AUDIT.md
- Contains high‑level audit policy and placeholder sections for active and deferred TODOs.

## Additional TODO / FIXME / STUB / AUDIT Comments (Tools Layer)

### tools/mcp-server/n8n-mcp/tests/unit/services/workflow-validator-edge-cases.test.ts
- Several `it.skip` tests marked with `FIXME` or `TODO` for mock issues and workflow validation.

### tools/mcp-server/n8n-mcp/tests/unit/services/enhanced-config-validator-type-structures.test.ts
- `// TODO: Debug why resourceLocator tests fail`.

---

## Noether Symmetry Audit (App Layer)

... (existing App audit omitted) ...

## Noether Symmetry Audit (Core Layer)

### 1. Time‑Translation Symmetry
- **Violation**: Direct use of `std::chrono::steady_clock::now()` in `core/src/Core/Infomatrix.cpp` (lines 48‑50) couples core logic to wall‑clock time.
- **Conserved Quantity**: Deterministic simulation timestamps.
- **Recommendation**: Replace with `SimulationClock::Now()` from the central clock service and inject the clock where needed.

### 2. Global‑State Conservation
- **Violation**: Placeholder `Stub,` in `core/include/RogueCity/Core/Editor/GlobalState.hpp` (line 296) indicates unfinished handling of global state.
- **Conserved Quantity**: Consistent editor state across frames.
- **Recommendation**: Implement a concrete state representation and ensure all mutations go through the HFSM command pipeline rather than ad‑hoc stubs.

### 3. Resource‑Budget Conservation
- **Violation**: Temporary objects created in core modules (e.g., Infomatrix timing) are not allocated from RAII pools, risking handle leaks.
- **Conserved Quantity**: Fixed resource usage.
- **Recommendation**: Allocate transient data using `civ::IndexVector<T>` pools and ensure deterministic reclamation.

---

*Findings derived from the OptimizationContract_Noether.md and the current Core source tree.*

---

## 2026-02-28 Dev Shell + AI Bridge Audit Addendum

### Objective
- Close remaining toolchain warning (`VSCMD_VER missing`) in `env_doctor`.
- Validate visualizer build path, AI bridge connectivity, and practical `rc-*` tool suite health.

### Audit Actions
1. Updated `tools/env_doctor.py` toolchain probe to use `set VSCMD_VER` after `.vscode\vsdev-init.cmd`, avoiding cmd expansion false negatives.
2. Re-ran environment doctor and verified all checks pass (`PASS=6 WARN=0 FAIL=0`).
3. Built `RogueCityVisualizerGui` through VS dev shell + CMake build path; verified successful target output.
4. Ran AI bridge connectivity smoke in mock mode against:
   - `GET /health`
   - `POST /ui_agent`
   - `POST /city_spec`
5. Ran `rc-*` smoke suite (`rc-env`, `rc-context`, `rc-doctor`, `rc-contract`, `rc-problems`, `rc-pdiff`, `rc-index`, `rc-cfg`, `rc-bld-vis`) and captured all-pass results.

### Findings
- Toolchain warning issue is resolved.
- Build pipeline for visualizer is healthy under current configuration.
- AI bridge local mock path is healthy and responsive across core endpoints.
- Remaining diagnostics are dominated by markdown/cSpell in `CHANGELOG.md`; non-blocking but noisy.

### Risk/Impact
- **Runtime/Build Risk:** Low after fixes.
- **Developer Experience Risk:** Moderate due to lint-noise concentration in changelog affecting triage readability.

### Recommendation
- Keep current env doctor/tooling changes as baseline.
- Consider adding an automated `rc-ai-smoke` command to codify endpoint health validation and reduce manual verification effort.

---

## 2026-02-28 Headless + Local AI Workflow Audit Addendum

### Scope
- Validate newly added headless run/build commands for real program smoke coverage.
- Validate local non-mock AI path and local model query workflow.
- Harden AI bridge start/stop scripts for non-interactive shell use.

### Implemented
1. Added `rc-bld-headless`, `rc-run-headless`, and `rc-smoke-headless` in `tools/dev-shell.ps1`.
2. Added `rc-ai-query` in `tools/dev-shell.ps1` with workspace directive injection from:
   - `.gemini/GEMINI.md`
   - `.agents/Agents.md`
3. Updated bridge lifecycle wrappers:
   - `rc-ai-start` now calls `Start_Ai_Bridge_Fixed.ps1 -MockMode:$false -NonInteractive`
   - `rc-ai-stop` now calls `Stop_Ai_Bridge_Fixed.ps1 -NonInteractive`
4. Hardened `Start_Ai_Bridge_Fixed.ps1` and `Stop_Ai_Bridge_Fixed.ps1`:
   - Added `-NonInteractive` flow controls.
   - Removed `$pid` reserved-variable usage in stop script.
   - Added `netstat` fallback logic when unavailable.
   - Improved stop diagnostics and task-kill fallback handling.

### Validation Results
- `rc-smoke-headless -TimeoutSec 3`: **PASS** (process starts and exits within timeout).
- `rc-ai-smoke -Live -Model deepseek-coder-v2:16b`: **PASS**
  - `/health`: OK
  - `/city_spec`: valid response (districts returned)
  - `/ui_agent`: no transport/API errors
- `rc-ai-query -Model deepseek-coder-v2:16b -Prompt "Return exactly: RC_OK"`: **PASS** (local model response returned).
- `Start_Ai_Bridge_Fixed.ps1 -MockMode -NonInteractive`: **PASS** (bridge reaches health check).

### Findings / Remaining Risk
- In this shell context, `rc-ai-stop` can encounter a listener PID (`7077`) where process metadata is inaccessible and termination fails from the current session.
- Impact: bridge functionality remains healthy, but stop automation is not fully deterministic across mixed shell ownership contexts.
- Recommendation: standardize bridge start/stop under the same shell/user context, or add an elevated helper for force-stop in environments with PID visibility constraints.

---

## 2026-02-28 Bridge Hardening + UI Comparison Addendum

### Process Hardening Implemented
1. Added toolserver health metadata:
   - `/health` now returns `mock` and `pid` in addition to status/service.
2. Added controlled bridge shutdown endpoint:
   - `POST /admin/shutdown` for local loopback stop requests.
3. Removed `uvicorn --reload` default from bridge startup:
   - avoids watcher/orphan process behavior during automation.
4. Added port parameterization:
   - `rc-ai-start`, `rc-ai-stop`, `rc-ai-restart` now support `-Port`.
5. Added start-mode reuse protection:
   - live start refuses reuse of healthy mock bridge when forced restart cannot terminate inherited listener.
   - legacy mode probe fallback added via `/ui_agent` when `/health` lacks `mock`.
6. Fixed local AI query reliability:
   - `rc-ai-query` now sends UTF-8 JSON bytes and strips control chars from context file text.

### Validation
- `rc-ai-start -Port 7088`: PASS (healthy live bridge with `mock:false`, `pid` reported).
- `rc-ai-stop -Port 7088`: PASS (listener removed, health unavailable after stop).
- `rc-ai-smoke -Live -Port 7088`: PASS (`/health`, `/ui_agent`, `/city_spec` all healthy).
- `rc-ai-query`: PASS after UTF-8 payload fix.
- `RogueCityVisualizerHeadless` rebuilt with CLI snapshot export support and generated:
  - `AI/docs/ui/ui_introspection_headless_latest.json`

### Outstanding Operational Constraint
- Inherited stale listener on `7077` may still be non-terminable from this shell context due process ownership/visibility limits.
- Mitigation now available:
  - use `-Port` to run a clean isolated bridge (validated on `7088`).
