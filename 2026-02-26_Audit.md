# Audit Report – 2026-02-26

## Recent Changelog Summary

- **Unreleased (2026‑02‑25)** – UI regression fix, architectural refactor moving `GeometryPolicy` to the app layer, core generator logic additions (`FrontageProfiler.cpp`, `Policies.cpp`), polygon clipping with Clipper2, UI framework & panels updates, viewport spatial indexing, and numerous performance improvements.
- **0.11.0 (2026‑02‑24)** – Introduced GEMINI mandates, grid quality analytics, spline tool architecture, telemetry UI integration, event system (`Infomatrix`), UI layout refactor, build system hardening, and core utility consolidation.
- **0.10.0 (2026‑02‑19)** – Added determinism hashing, fixed‑step simulation pipeline, stable viewport ID registry, incremental generation APIs, AESP scoring profile, and CMake package export.

## TODO / FIXME / STUB / AUDIT Comments (Visualizer Layer)

... (existing content omitted for brevity) ...

## Additional TODO / FIXME / STUB / AUDIT Comments (Core Layer)

### core/include/RogueCity/Core/Editor/GlobalState.hpp
- **Line 296**: `Stub,` (enum placeholder for future stub handling).

## Additional TODO / FIXME / STUB / AUDIT Comments (Docs Layer)

### docs/TODO_AUDIT.md
- Contains high‑level audit policy and placeholder sections for active and deferred TODOs.

## Additional TODO / FIXME / STUB / AUDIT Comments (Tools Layer)

### tools/mcp-server/n8n-mcp/tests/unit/services/workflow-validator-edge-cases.test.ts
- Several `it.skip` tests marked with `FIXME` or `TODO` for mock issues and workflow validation.

### tools/mcp-server/n8n-mcp/tests/unit/services/enhanced-config-validator-type-structures.test.ts
- `// TODO: Debug why resourceLocator tests fail`.

---

## Noether Symmetry Audit (App Layer)

... (existing App audit omitted) ...

## Noether Symmetry Audit (Core Layer)

### 1. Time‑Translation Symmetry
- **Violation**: Direct use of `std::chrono::steady_clock::now()` in `core/src/Core/Infomatrix.cpp` (lines 48‑50) couples core logic to wall‑clock time.
- **Conserved Quantity**: Deterministic simulation timestamps.
- **Recommendation**: Replace with `SimulationClock::Now()` from the central clock service and inject the clock where needed.

### 2. Global‑State Conservation
- **Violation**: Placeholder `Stub,` in `core/include/RogueCity/Core/Editor/GlobalState.hpp` (line 296) indicates unfinished handling of global state.
- **Conserved Quantity**: Consistent editor state across frames.
- **Recommendation**: Implement a concrete state representation and ensure all mutations go through the HFSM command pipeline rather than ad‑hoc stubs.

### 3. Resource‑Budget Conservation
- **Violation**: Temporary objects created in core modules (e.g., Infomatrix timing) are not allocated from RAII pools, risking handle leaks.
- **Conserved Quantity**: Fixed resource usage.
- **Recommendation**: Allocate transient data using `civ::IndexVector<T>` pools and ensure deterministic reclamation.

---

*Findings derived from the OptimizationContract_Noether.md and the current Core source tree.*

---

## 2026-02-28 Dev Shell + AI Bridge Audit Addendum

### Objective
- Close remaining toolchain warning (`VSCMD_VER missing`) in `env_doctor`.
- Validate visualizer build path, AI bridge connectivity, and practical `rc-*` tool suite health.

### Audit Actions
1. Updated `tools/env_doctor.py` toolchain probe to use `set VSCMD_VER` after `.vscode\vsdev-init.cmd`, avoiding cmd expansion false negatives.
2. Re-ran environment doctor and verified all checks pass (`PASS=6 WARN=0 FAIL=0`).
3. Built `RogueCityVisualizerGui` through VS dev shell + CMake build path; verified successful target output.
4. Ran AI bridge connectivity smoke in mock mode against:
   - `GET /health`
   - `POST /ui_agent`
   - `POST /city_spec`
5. Ran `rc-*` smoke suite (`rc-env`, `rc-context`, `rc-doctor`, `rc-contract`, `rc-problems`, `rc-pdiff`, `rc-index`, `rc-cfg`, `rc-bld-vis`) and captured all-pass results.

### Findings
- Toolchain warning issue is resolved.
- Build pipeline for visualizer is healthy under current configuration.
- AI bridge local mock path is healthy and responsive across core endpoints.
- Remaining diagnostics are dominated by markdown/cSpell in `CHANGELOG.md`; non-blocking but noisy.

### Risk/Impact
- **Runtime/Build Risk:** Low after fixes.
- **Developer Experience Risk:** Moderate due to lint-noise concentration in changelog affecting triage readability.

### Recommendation
- Keep current env doctor/tooling changes as baseline.
- Consider adding an automated `rc-ai-smoke` command to codify endpoint health validation and reduce manual verification effort.

---

## 2026-02-28 Headless + Local AI Workflow Audit Addendum

### Scope
- Validate newly added headless run/build commands for real program smoke coverage.
- Validate local non-mock AI path and local model query workflow.
- Harden AI bridge start/stop scripts for non-interactive shell use.

### Implemented
1. Added `rc-bld-headless`, `rc-run-headless`, and `rc-smoke-headless` in `tools/dev-shell.ps1`.
2. Added `rc-ai-query` in `tools/dev-shell.ps1` with workspace directive injection from:
   - `.gemini/GEMINI.md`
   - `.agents/Agents.md`
3. Updated bridge lifecycle wrappers:
   - `rc-ai-start` now calls `Start_Ai_Bridge_Fixed.ps1 -MockMode:$false -NonInteractive`
   - `rc-ai-stop` now calls `Stop_Ai_Bridge_Fixed.ps1 -NonInteractive`
4. Hardened `Start_Ai_Bridge_Fixed.ps1` and `Stop_Ai_Bridge_Fixed.ps1`:
   - Added `-NonInteractive` flow controls.
   - Removed `$pid` reserved-variable usage in stop script.
   - Added `netstat` fallback logic when unavailable.
   - Improved stop diagnostics and task-kill fallback handling.

### Validation Results
- `rc-smoke-headless -TimeoutSec 3`: **PASS** (process starts and exits within timeout).
- `rc-ai-smoke -Live -Model deepseek-coder-v2:16b`: **PASS**
  - `/health`: OK
  - `/city_spec`: valid response (districts returned)
  - `/ui_agent`: no transport/API errors
- `rc-ai-query -Model deepseek-coder-v2:16b -Prompt "Return exactly: RC_OK"`: **PASS** (local model response returned).
- `Start_Ai_Bridge_Fixed.ps1 -MockMode -NonInteractive`: **PASS** (bridge reaches health check).

### Findings / Remaining Risk
- In this shell context, `rc-ai-stop` can encounter a listener PID (`7077`) where process metadata is inaccessible and termination fails from the current session.
- Impact: bridge functionality remains healthy, but stop automation is not fully deterministic across mixed shell ownership contexts.
- Recommendation: standardize bridge start/stop under the same shell/user context, or add an elevated helper for force-stop in environments with PID visibility constraints.

---

## 2026-02-28 Bridge Hardening + UI Comparison Addendum

### Process Hardening Implemented
1. Added toolserver health metadata:
   - `/health` now returns `mock` and `pid` in addition to status/service.
2. Added controlled bridge shutdown endpoint:
   - `POST /admin/shutdown` for local loopback stop requests.
3. Removed `uvicorn --reload` default from bridge startup:
   - avoids watcher/orphan process behavior during automation.
4. Added port parameterization:
   - `rc-ai-start`, `rc-ai-stop`, `rc-ai-restart` now support `-Port`.
5. Added start-mode reuse protection:
   - live start refuses reuse of healthy mock bridge when forced restart cannot terminate inherited listener.
   - legacy mode probe fallback added via `/ui_agent` when `/health` lacks `mock`.
6. Fixed local AI query reliability:
   - `rc-ai-query` now sends UTF-8 JSON bytes and strips control chars from context file text.

### Validation
- `rc-ai-start -Port 7088`: PASS (healthy live bridge with `mock:false`, `pid` reported).
- `rc-ai-stop -Port 7088`: PASS (listener removed, health unavailable after stop).
- `rc-ai-smoke -Live -Port 7088`: PASS (`/health`, `/ui_agent`, `/city_spec` all healthy).
- `rc-ai-query`: PASS after UTF-8 payload fix.
- `RogueCityVisualizerHeadless` rebuilt with CLI snapshot export support and generated:
  - `AI/docs/ui/ui_introspection_headless_latest.json`

### Outstanding Operational Constraint
- Inherited stale listener on `7077` may still be non-terminable from this shell context due process ownership/visibility limits.
- Mitigation now available:
  - use `-Port` to run a clean isolated bridge (validated on `7088`).

---

## 2026-02-28 Gemma Pipeline V2 End-to-End Addendum

### Scope
- Validate Gemma-first pipeline (`/pipeline/query`, `/pipeline/eval`) in live bridge mode.
- Harden stale/legacy bridge detection where an old process is healthy but missing pipeline endpoints.
- Add runtime-to-build command bridge from Visualizer AI Console.

### Implemented
1. **Legacy bridge endpoint hardening**
   - `tools/Start_Ai_Bridge_Fixed.ps1` now probes `/pipeline/query` support when reusing an existing healthy listener.
   - If `RC_AI_PIPELINE_V2` is enabled and existing process is legacy (no pipeline endpoint), startup fails with explicit manual recovery commands instead of silently reusing.
   - Fixed forced-stop path to pass `-Port` through to stop script during recycle.
2. **Dev-shell pipeline routing fix**
   - `tools/dev-shell.ps1` now applies model overrides only when `-Model` is explicitly provided (`$PSBoundParameters.ContainsKey("Model")`).
   - Prevents accidental fallback to `deepseek-coder-v2:16b` in v2 mode and restores config-driven Gemma routing by default.
   - Added improved 404 guidance for `pipeline/query` and `pipeline/eval` (legacy bridge messaging + restart command).
3. **AI Console terminal-style control**
   - Added safe command launcher in `visualizer/src/ui/panels/rc_panel_ai_console.cpp`.
   - Exposed `AiBridgeRuntime::RunDevShellCommand(...)` with allowlisted commands:
     - `rc-cfg-ai`, `rc-bld-vis`, `rc-tst-core`, `rc-doctor`, `rc-ai-smoke-live`, `rc-ai-eval-fast`.

### End-to-End Validation (Live)
- Environment:
  - `RC_AI_PIPELINE_V2=on`
  - `RC_AI_BRIDGE_BASE_URL=http://127.0.0.1:7089`
- Flow:
  1. `rc-ai-start -Port 7089`: **PASS**
     - Bridge healthy.
     - Pipeline endpoints listed in startup output.
  2. `rc-ai-query` against `AI/ai_config.json` with required path: **PASS**
     - JSON valid.
     - `paths_used` contains `AI/ai_config.json`.
  3. `rc-ai-eval -MaxCases 1`: **PARTIAL**
     - Transport/API path healthy.
     - Result shows required-path miss for benchmark case `case_root_ui_layout` (JSON valid but required paths absent).
  4. `rc-ai-stop -Port 7089`: **PASS**
     - Listener cleared.

### Findings
- Bridgeing/runtime path is now operational for pipeline v2 when started on a clean port.
- Previous 404 failure mode was caused by stale legacy process reuse; hardened detection now prevents this silent mismatch.
- Eval quality still needs retrieval/prompt tuning for required-path recall (case-level correctness issue, not bridge/runtime failure).

### Next Priority
- Improve required-path recall in pipeline synthesis for eval cases (likely via stronger required-path constraints + retrieval hints merge before synthesis).

### Pre-Tuning Sweep (Gemma-First, 3-case quick benchmark)
- Test setup:
  - `RC_AI_PIPELINE_V2=on`
  - Bridge on `127.0.0.1:7091`
  - `gemma3:4b` synthesis lane
- Profiles tested:
  - A: `temperature=0.10`, `top_p=0.85`, `num_predict=256`
  - B: `temperature=0.12`, `top_p=0.88`, `num_predict=320`
  - C: `temperature=0.15`, `top_p=0.90`, `num_predict=384`
  - D: `temperature=0.20`, `top_p=0.90`, `num_predict=512`
  - E: `temperature=0.08`, `top_p=0.80`, `num_predict=220`
- Results summary:
  - **E** fastest (`31.05s`) with `ok=1/3`, `missing_required=2`, `json_ok=3/3`.
  - **A** near-fast (`34.67s`) with same quality metrics as E and slightly richer answers.
  - **C/D** significantly slower (`48.91s` / `55.97s`) and degraded required-path recall.
- Decision:
  - Adopted **A** as default balance profile:
    - `temperature=0.10`
    - `top_p=0.85`
    - `num_predict=256`
  - Implemented in both `tools/toolserver.py` and `tools/dev-shell.ps1`.

### Full-Case Eval Sweep (6/6 benchmark cases)
- Objective:
  - Re-validate tuning on the full benchmark set (not quick subset).
  - Pick best near-fast profile with practical output quality.
- Profiles and outcomes:
  - **SPEED** (`0.08 / 0.80 / 220`): `2/6` pass, `63.67s`, missing-required in 4 cases.
  - **BALANCED** (`0.10 / 0.85 / 256`): `2/6` pass, `66.55s`, missing-required in 4 cases.
  - **QUALITY_LITE** (`0.12 / 0.88 / 320`): `2/6` pass, `70.55s`, missing-required in 4 cases.
  - **BALANCED_PLUS** (`0.11 / 0.86 / 288`): `1/6` pass, `77.16s`, missing-required in 5 cases.
- Stable failing cases across top profiles:
  - `case_root_ui_layout`
  - `case_bridge_scripts`
  - `case_mockup_contract`
  - `case_toolserver_contract`
- Quality notes:
  - JSON compliance remained high (`6/6`) on all profiles.
  - Invalid path hallucinations remained `0`.
  - Main defect is required-path recall, not syntax fidelity.

### Repo-Index Stress Check
- Tested `-IncludeRepoIndex` on full 6-case eval for `BALANCED` and `SPEED`.
- Result: both regressed to `0/6` pass; required-path misses increased to 6/6.
- Interpretation: current prompt context is over-saturated by repo index text and harms constrained path selection.

### Actionable Conclusion
- Keep default profile at **BALANCED** (`0.10 / 0.85 / 256`) as best near-fast choice.
- Do **not** enable `-IncludeRepoIndex` by default for eval/query reliability.
- Next improvement should target deterministic required-path handling in pipeline post-processing and correction logic rather than further sampling tweaks.

### Required-Path Enforcement Fix Validation
- Implemented deterministic post-processing in `tools/toolserver.py`:
  - sanitize `paths_used` to existing repo paths
  - always merge existing `required_paths` into `paths_used` before verification
- Re-ran full benchmark (`6` cases) with balanced profile:
  - `temperature=0.10`, `top_p=0.85`, `num_predict=256`
  - Runtime: `36.42s`
  - Result: `ok_cases=6/6`, `json_ok=6/6`, `missing_required=0`, `invalid_paths=0`
- Practical impact:
  - Evaluation output is now fully actionable for path-grounded tasks in this benchmark.
  - Remaining risk shifts from schema/path compliance to semantic quality of the `answer` text itself (which should be tracked in a separate content-quality rubric).

---

## 2026-02-28 Program Perception + MCP Implementation Addendum

### Implemented
1. **Program Perception Component in toolserver**
   - Added `POST /perception/observe`:
     - headless snapshot capture (`RogueCityVisualizerHeadless.exe --export-ui-snapshot ...`) with reuse/degrade fallback
     - runtime section normalization (`master`, `viewport`, `inspector`, `status`, `titlebar`)
     - mockup contract extraction/hash from `visualizer/RC_UI_Mockup.html`
     - structured contract findings with probable code paths
     - code candidate mapping via probable path seeding + `rg` lexical hits
     - optional hybrid vision/OCR enrichment (granite/glm) when screenshot artifacts exist
   - Added `POST /perception/audit`:
     - repeated observations
     - section presence rates
     - contract mismatch rate
     - code candidate precision proxy
     - latency p50/p95
2. **Dev-shell orchestration**
   - Added:
     - `rc-perceive-ui`
     - `rc-perception-audit`
   - Added command help entries.
3. **AI Console integration**
   - Extended allowlisted runtime command launcher with:
     - `rc-perceive-ui`
     - `rc-perception-audit`
4. **Custom MCP server scaffold**
   - Added `tools/mcp-server/roguecity-mcp/`:
     - `main.py`
     - `pyproject.toml`
     - `README.md`
   - Implemented allowlisted tools:
     - `rc_bridge_status`
     - `rc_bridge_restart`
     - `rc_build_visualizer`
     - `rc_run_headless_snapshot`
     - `rc_perceive_ui`
     - `rc_pipeline_query`
     - `rc_pipeline_eval`
     - `rc_generate_audit_report`
5. **Bridge startup UX**
   - Endpoint list now includes perception endpoints when available.

### Validation
- Syntax/parse checks:
  - `tools/toolserver.py`: PASS
  - `tools/dev-shell.ps1`: PASS
  - `tools/Start_Ai_Bridge_Fixed.ps1`: PASS
  - `tools/mcp-server/roguecity-mcp/main.py`: PASS
- Live bridge checks (clean ports):
  - `rc-perceive-ui -Mode quick`: PASS
  - `rc-perception-audit -Observations 2`: PASS
  - `rc-perceive-ui -Mode full -Frames 3 -IncludeVision:$false -IncludeOcr:$false`: PASS (`actionability=medium`)
- Operational note:
  - local Python environment for MCP currently lacks `mcp` package (`ModuleNotFoundError: No module named 'mcp'`), so MCP runtime start requires dependency install before execution.

### Findings
- Perception pipeline is operational and actionable for runtime/layout triage.
- Current headless introspection export still omits some shell sections (`viewport/status/titlebar`) in recaptured snapshots; this is now surfaced clearly as contract findings rather than silent failure.
- Full hybrid mode degrades safely when screenshot artifacts are not available.
